<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª - MIFT Car Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Cairo', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

<script>

/* ============================================================
   Firebase Security Rules - ÙŠØ¬Ø¨ ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§
   ============================================================
   Ø§ÙØªØ­ Firebase Console > Firestore Database > Rules

   rules_version = '2';
   service cloud.firestore {
     match /databases/{database}/documents {
       match /users/{userId} {
         allow read, write: if request.auth != null && request.auth.uid == userId;
       }
       match /cars/{carId} {
         allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
       }
       match /repairs/{repairId} {
         allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
       }
       match /invoices/{invoiceId} {
         allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
       }
     }
   }
============================================================ */

        const firebaseConfig = {
    apiKey: "AIzaSyAVs6ClD59pf6BGHDZ1g7Bc-vN9ZW6UezU",
    authDomain: "mift-car-profile.firebaseapp.com",
    projectId: "mift-car-profile",
    storageBucket: "mift-car-profile.firebasestorage.app",
    messagingSenderId: "851540250746",
    appId: "1:851540250746:web:600fc50d92cf054f17abc3"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>

<div id="loading" class="min-h-screen bg-gradient-to-br from-blue-900 to-teal-700 flex items-center justify-center">
    <div class="text-center text-white">
        <div class="loader mx-auto mb-4"></div>
        <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
    </div>
</div>

<div id="authScreen" class="hidden min-h-screen bg-gradient-to-br from-blue-900 via-blue-800 to-teal-700 flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
        <div class="text-center mb-6">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-10 h-10 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0"></path>
                </svg>
            </div>
            <h1 class="text-2xl font-bold text-gray-800">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>
            <p class="text-sm text-gray-500">MIFT Car Profile</p>
        </div>
        <div id="authMsg" class="hidden p-3 rounded-lg mb-4 text-sm"></div>
        <div class="flex bg-gray-100 rounded-lg p-1 mb-4">
            <button onclick="switchAuth('login')" id="loginTab" class="flex-1 py-2 rounded-lg bg-blue-600 text-white transition">Ø¯Ø®ÙˆÙ„</button>
            <button onclick="switchAuth('register')" id="registerTab" class="flex-1 py-2 rounded-lg text-gray-600 transition">ØªØ³Ø¬ÙŠÙ„</button>
        </div>
        <div class="space-y-4">
            <input type="email" id="authEmail" class="w-full p-3 border rounded-lg" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
            <input type="password" id="authPassword" class="w-full p-3 border rounded-lg" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <div id="registerFields" class="hidden space-y-4">
                <input type="password" id="authPassword2" class="w-full p-3 border rounded-lg" placeholder="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <select id="authRole" class="w-full p-3 border rounded-lg">
                    <option value="user">Ù…Ø³ØªØ®Ø¯Ù…</option>
                    <option value="admin">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…</option>
                </select>
                <div class="bg-yellow-50 border border-yellow-300 rounded-lg p-3">
                    <label class="block text-sm text-yellow-800 font-medium mb-1">ğŸ” ÙƒÙ„Ù…Ø© Ø³Ø± Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… (Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ³Ø¬ÙŠÙ„)</label>
                    <input type="password" id="adminSecretKey" class="w-full p-3 border border-yellow-300 rounded-lg" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø³Ø¦ÙˆÙ„">
                </div>
            </div>
            <button onclick="submitAuth()" id="authBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 font-medium">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>
</div>

<div id="mainApp" class="hidden">
    <header class="bg-gradient-to-l from-blue-900 to-blue-700 text-white shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù…ØªØ§Ø¨Ø¹Ø© ØµÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h1>
                <p class="text-xs opacity-75">MIFT Car Profile</p>
            </div>
            <div class="flex items-center gap-3">
                <span id="userEmail" class="text-sm bg-white/20 px-3 py-1 rounded-full"></span>
                <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded text-sm hover:bg-red-600">Ø®Ø±ÙˆØ¬</button>
            </div>
        </div>
    </header>
    
    <nav class="bg-white shadow">
        <div class="container mx-auto flex">
            <button onclick="showScreen('cars')" id="navCars" class="px-6 py-3 font-medium text-blue-600 border-b-2 border-blue-600">Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</button>
            <button onclick="showScreen('maintenance')" id="navMaintenance" class="px-6 py-3 font-medium text-gray-600 border-b-2 border-transparent">Ø§Ù„ØµÙŠØ§Ù†Ø§Øª</button>
            <button onclick="showScreen('reports')" id="navReports" class="px-6 py-3 font-medium text-gray-600 border-b-2 border-transparent">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        </div>
    </nav>
    
    <div id="carsScreen" class="container mx-auto p-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</h2>
            <button onclick="openCarForm()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+ Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©</button>
        </div>
        <div id="carsList" class="space-y-3"></div>
    </div>
    
    <div id="maintenanceScreen" class="hidden container mx-auto p-4">
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <label class="block mb-2 font-medium">Ø§Ø®ØªØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
            <select id="carSelect" onchange="loadCarData()" class="w-full p-3 border rounded-lg">
                <option value="">-- Ø§Ø®ØªØ± Ø³ÙŠØ§Ø±Ø© --</option>
            </select>
        </div>
        <div id="carDetails" class="hidden">
            <div id="selectedCarInfo" class="bg-blue-50 rounded-lg p-4 mb-4"></div>
            <div class="flex gap-2 mb-4">
                <button onclick="showTab('repairs')" id="tabRepairs" class="flex-1 py-2 rounded-lg bg-blue-600 text-white">Ø§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª</button>
                <button onclick="showTab('invoices')" id="tabInvoices" class="flex-1 py-2 rounded-lg bg-white">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</button>
            </div>
            <div id="repairsTab" class="bg-white rounded-lg shadow p-4">
                <div class="flex justify-between mb-4">
                    <h3 class="font-bold">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­</h3>
                    <button onclick="openRepairForm()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+ Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <div id="repairsList"></div>
            </div>
            <div id="invoicesTab" class="hidden bg-white rounded-lg shadow p-4">
                <div class="flex justify-between mb-4">
                    <h3 class="font-bold">Ø§Ù„ÙÙˆØ§ØªÙŠØ±</h3>
                    <button onclick="openInvoiceForm()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+ Ø¥Ø¶Ø§ÙØ©</button>
                </div>
                <div id="invoicesList"></div>
            </div>
        </div>
    </div>
    
    <div id="reportsScreen" class="hidden container mx-auto p-4">
        <div class="bg-white rounded-lg shadow p-4 mb-4">
            <h2 class="font-bold mb-4 text-lg">Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
            
            <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¨Ø­Ø« -->
            <div class="flex gap-2 mb-4 flex-wrap">
                <button onclick="setSearchType('car')" id="searchTypeCar" class="px-4 py-2 rounded-lg bg-blue-600 text-white">Ø¨Ø­Ø« Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø©</button>
                <button onclick="setSearchType('invoice')" id="searchTypeInvoice" class="px-4 py-2 rounded-lg bg-gray-200">Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø©</button>
                <button onclick="setSearchType('item')" id="searchTypeItem" class="px-4 py-2 rounded-lg bg-gray-200">Ø¨Ø­Ø« Ø¨ØµÙ†Ù</button>
            </div>
            
            <!-- Ø¨Ø­Ø« Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø© -->
            <div id="searchByCar" class="space-y-3">
                <div class="flex gap-2">
                    <input id="searchQuery" class="flex-1 p-3 border rounded-lg" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù„ÙˆØ­Ø©ØŒ Ø§Ù„Ù…Ø§Ø±ÙƒØ©...">
                    <button onclick="searchCars()" class="bg-blue-600 text-white px-6 rounded-lg">Ø¨Ø­Ø«</button>
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">Ø£Ùˆ Ø§Ø®ØªØ± Ø³ÙŠØ§Ø±Ø© Ù„Ø¹Ø±Ø¶ ÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡Ø§:</label>
                    <select id="reportCarSelect" onchange="loadCarReport()" class="w-full p-3 border rounded-lg">
                        <option value="">-- Ø§Ø®ØªØ± Ø³ÙŠØ§Ø±Ø© --</option>
                    </select>
                </div>
            </div>
            
            <!-- Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… ÙØ§ØªÙˆØ±Ø© -->
            <div id="searchByInvoice" class="hidden">
                <div class="flex gap-2">
                    <input id="invoiceSearchQuery" class="flex-1 p-3 border rounded-lg" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©...">
                    <button onclick="searchByInvoiceNum()" class="bg-blue-600 text-white px-6 rounded-lg">Ø¨Ø­Ø«</button>
                </div>
            </div>
            
            <!-- Ø¨Ø­Ø« Ø¨ØµÙ†Ù -->
            <div id="searchByItem" class="hidden">
                <div class="flex gap-2">
                    <input id="itemSearchQuery" class="flex-1 p-3 border rounded-lg" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù...">
                    <button onclick="searchByItemName()" class="bg-blue-600 text-white px-6 rounded-lg">Ø¨Ø­Ø«</button>
                </div>
            </div>
        </div>
        
        <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª -->
        <div id="searchResults" class="hidden bg-white rounded-lg shadow p-4 mb-4">
            <div class="flex justify-between mb-4">
                <h3 class="font-bold">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</h3>
                <button onclick="exportCSV()" class="bg-green-600 text-white px-4 py-1 rounded text-sm">ØªØµØ¯ÙŠØ± CSV</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-2 text-right">Ø§Ù„Ù„ÙˆØ­Ø©</th>
                            <th class="p-2 text-right">Ø§Ù„Ù…Ø§Ø±ÙƒØ©</th>
                            <th class="p-2 text-right">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th>
                            <th class="p-2 text-right">Ø§Ù„Ù†ÙˆØ¹</th>
                            <th class="p-2 text-right">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody"></tbody>
                </table>
            </div>
        </div>
        
        <!-- ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø´Ø§Ù…Ù„ -->
        <div id="carReportSection" class="hidden">
            <div class="bg-white rounded-lg shadow p-4 mb-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„Ø³ÙŠØ§Ø±Ø©</h3>
                    <button onclick="downloadCarReportPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                        <span>ğŸ“„</span> ØªØ­Ù…ÙŠÙ„ PDF
                    </button>
                </div>
                <div id="carReportContent"></div>
            </div>
        </div>
        
        <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙØ§ØªÙˆØ±Ø© -->
        <div id="invoiceSearchResults" class="hidden bg-white rounded-lg shadow p-4 mb-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙØ§ØªÙˆØ±Ø©</h3>
                <button onclick="downloadInvoiceReportPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span>ğŸ“„</span> ØªØ­Ù…ÙŠÙ„ PDF
                </button>
            </div>
            <div id="invoiceResultsContent"></div>
        </div>
        
        <!-- Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØµÙ†Ù -->
        <div id="itemSearchResults" class="hidden bg-white rounded-lg shadow p-4 mb-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØµÙ†Ù</h3>
                <button onclick="downloadItemReportPDF()" class="bg-red-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <span>ğŸ“„</span> ØªØ­Ù…ÙŠÙ„ PDF
                </button>
            </div>
            <div id="itemResultsContent"></div>
        </div>
    </div>
</div>

<!-- Car Form Modal - Ù…Ø­Ø¯Ø« Ø¨Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
<div id="carModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6">
        <h3 id="carFormTitle" class="text-lg font-bold mb-4 text-blue-800">Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø©</h3>
        
        <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
        <div class="bg-blue-50 p-4 rounded-lg mb-4">
            <h4 class="font-bold text-blue-700 mb-3">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© *</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <input id="plateL" class="p-2 border rounded" placeholder="Ø­Ø±ÙˆÙ Ø§Ù„Ù„ÙˆØ­Ø© *">
                <input id="plateN" class="p-2 border rounded" placeholder="Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù„ÙˆØ­Ø© *">
                <input id="brand" class="p-2 border rounded" placeholder="Ø§Ù„Ù…Ø§Ø±ÙƒØ© *">
                <input id="year" class="p-2 border rounded" placeholder="Ø³Ù†Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ *">
                <input id="engine" class="p-2 border rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØªÙˆØ± *">
                <input id="chassis" class="p-2 border rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠØ© *">
                <input id="cyl" class="p-2 border rounded" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù„Ù†Ø¯Ø±Ø§Øª *">
                <select id="carType" class="p-2 border rounded">
                    <option value="">Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø© *</option>
                    <option>Ù„ÙŠÙ…ÙˆØ²ÙŠÙ†</option><option>Ø¬ÙŠØ¨</option><option>Ù…ÙŠÙƒØ±ÙˆØ¨Ø§Øµ</option>
                    <option>Ù…ÙŠÙ†Ù‰ Ø¨Ø§Øµ</option><option>Ø§ØªÙˆØ¨ÙŠØ³</option><option>Ø¨ÙŠÙƒ Ø§Ø¨</option>
                </select>
                <select id="status" class="p-2 border rounded">
                    <option value="">Ø­Ø§Ù„Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø© *</option>
                    <option>ØµØ§Ù„Ø­Ø©</option><option>ØªØ­Øª Ø§Ù„Ø§ØµÙ„Ø§Ø­</option><option>Ù…Ø¹Ø·Ù„Ø©</option><option>Ù…ÙƒÙ‡Ù†Ø©</option>
                </select>
                <div>
                    <label class="block text-xs text-gray-600 mb-1">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ±Ø®ÙŠØµ *</label>
                    <input type="date" id="licStart" class="p-2 border rounded w-full">
                </div>
                <input id="licAuth" class="p-2 border rounded" placeholder="Ø¬Ù‡Ø© Ø§Ù„ØªØ±Ø®ÙŠØµ *">
                <select id="fuel" class="p-2 border rounded">
                    <option value="">Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ‚ÙˆØ¯ *</option>
                    <option>Ø¨Ù†Ø²ÙŠÙ†</option><option>Ø³ÙˆÙ„Ø§Ø±</option><option>ØºØ§Ø² Ø·Ø¨ÙŠØ¹Ù‰</option>
                </select>
            </div>
        </div>
        
        <!-- Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© -->
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <h4 class="font-bold text-gray-700 mb-3">Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±Ù‰)</h4>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <input id="carUsers" class="p-2 border rounded" placeholder="Ù…Ø³ØªØ®Ø¯Ù…Ùˆ Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Ø§Ù„ÙˆØ¸ÙŠÙØ©)">
                <input id="custodian" class="p-2 border rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø¨Ø¹Ù‡Ø¯ØªÙ‡ Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
                <div>
                    <label class="block text-xs text-gray-600 mb-1">ØªØ§Ø±ÙŠØ® ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªØ±Ø®ÙŠØµ</label>
                    <input type="date" id="licRenewal" class="p-2 border rounded w-full">
                </div>
                <input id="ownership" class="p-2 border rounded" placeholder="ØªØ³Ù„Ø³Ù„ Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
                <div>
                    <label class="block text-xs text-gray-600 mb-1">ØªØ§Ø±ÙŠØ® Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©</label>
                    <input type="date" id="maintDate" class="p-2 border rounded w-full">
                </div>
                <input id="odometer" class="p-2 border rounded" placeholder="Ù‚Ø±Ø§Ø¡Ø© Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø©">
                <input id="maintOdometer" class="p-2 border rounded" placeholder="Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¹Ù†Ø¯ Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø©">
                <input id="maintTasks" class="p-2 border rounded" placeholder="Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ù…Ù†ÙØ°Ø© / Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±">
                <input id="supplier" class="p-2 border rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ ÙˆØ·Ø±ÙŠÙ‚Ø© Ø§Ù„ØªØ¹Ø§Ù‚Ø¯">
                <div>
                    <label class="block text-xs text-gray-600 mb-1">Ù…ÙˆØ¹Ø¯ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„Ù‰</label>
                    <input type="date" id="nextMaint" class="p-2 border rounded w-full">
                </div>
            </div>
        </div>
        
        <!-- ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ© -->
        <div class="bg-yellow-50 p-4 rounded-lg mb-4">
            <h4 class="font-bold text-yellow-700 mb-3">ØµÙˆØ±Ø© Ø§Ù„Ø±Ø®ØµØ© (Ø§Ø®ØªÙŠØ§Ø±Ù‰)</h4>
            <div class="flex items-center gap-4">
                <input type="file" id="licImage" accept="image/*" onchange="previewImage(event)" class="text-sm">
                <div id="imagePreview" class="hidden">
                    <img id="previewImg" class="h-20 rounded border">
                </div>
            </div>
        </div>
        
        <div class="flex gap-2 justify-end">
            <button onclick="closeCarForm()" class="px-4 py-2 border rounded hover:bg-gray-100">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="saveCar()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Ø­ÙØ¸</button>
        </div>
    </div>
</div>

<!-- Repair Form Modal -->
<div id="repairModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
        <h3 class="font-bold mb-4">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø·Ù„Ø¨ Ø¥ØµÙ„Ø§Ø­</h3>
        <div class="space-y-3">
            <div>
                <label class="block text-xs text-gray-600 mb-1">Ø§Ù„ØªØ§Ø±ÙŠØ® *</label>
                <input type="date" id="repairDate" class="w-full p-2 border rounded">
            </div>
            <input id="repairDriver" class="w-full p-2 border rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚ *">
            <input id="repairOdometer" class="w-full p-2 border rounded" placeholder="Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯">
            
            <!-- Ø§Ù„Ø£ØµÙ†Ø§Ù -->
            <div class="bg-gray-50 p-3 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <label class="font-medium text-sm">Ø§Ù„Ø£ØµÙ†Ø§Ù</label>
                    <button type="button" onclick="addRepairItem()" class="bg-green-500 text-white px-2 py-1 rounded text-xs">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                </div>
                <div id="repairItemsList" class="space-y-2"></div>
            </div>
            
            <div>
                <label class="block text-xs text-gray-600 mb-1">Ù…Ù„Ù PDF Ù„Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="file" id="repairPdf" accept=".pdf" onchange="previewRepairPdf(event)" class="w-full p-2 border rounded text-sm">
                <div id="repairPdfPreview" class="hidden mt-2 p-2 bg-gray-100 rounded flex items-center gap-2">
                    <span class="text-red-600">ğŸ“„</span>
                    <span id="repairPdfName" class="text-sm"></span>
                    <button onclick="removeRepairPdf()" class="text-red-500 text-sm mr-auto">Ø­Ø°Ù</button>
                </div>
            </div>
        </div>
        <div class="flex gap-2 mt-4 justify-end">
            <button onclick="closeRepairForm()" class="px-4 py-2 border rounded">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="saveRepair()" class="px-4 py-2 bg-blue-600 text-white rounded">Ø­ÙØ¸</button>
        </div>
    </div>
</div>

<!-- Invoice Form Modal -->
<div id="invoiceModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
        <h3 class="font-bold mb-4">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ÙØ§ØªÙˆØ±Ø©</h3>
        <div class="space-y-3">
            <input id="invNum" class="w-full p-2 border rounded" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© *">
            <input id="invVendor" class="w-full p-2 border rounded" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø© *">
            
            <!-- Ø§Ù„Ø£ØµÙ†Ø§Ù -->
            <div class="bg-gray-50 p-3 rounded-lg">
                <div class="flex justify-between items-center mb-2">
                    <label class="font-medium text-sm">Ø§Ù„Ø£ØµÙ†Ø§Ù</label>
                    <button type="button" onclick="addInvItem()" class="bg-green-500 text-white px-2 py-1 rounded text-xs">+ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                </div>
                <div id="invItemsList" class="space-y-2"></div>
            </div>
            
            <div>
                <label class="block text-xs text-gray-600 mb-1">Ù…Ù„Ù PDF Ù„Ù„ÙØ§ØªÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="file" id="invPdf" accept=".pdf" onchange="previewInvPdf(event)" class="w-full p-2 border rounded text-sm">
                <div id="invPdfPreview" class="hidden mt-2 p-2 bg-gray-100 rounded flex items-center gap-2">
                    <span class="text-red-600">ğŸ“„</span>
                    <span id="invPdfName" class="text-sm"></span>
                    <button onclick="removeInvPdf()" class="text-red-500 text-sm mr-auto">Ø­Ø°Ù</button>
                </div>
            </div>
        </div>
        <div class="flex gap-2 mt-4 justify-end">
            <button onclick="closeInvoiceForm()" class="px-4 py-2 border rounded">Ø¥Ù„ØºØ§Ø¡</button>
            <button onclick="saveInvoice()" class="px-4 py-2 bg-blue-600 text-white rounded">Ø­ÙØ¸</button>
        </div>
    </div>
</div>

<script>
let currentUser = null;
let authMode = 'login';
let editingCarId = null;
let selectedCarId = null;
let allCars = [];
let licenseImageBase64 = '';
let repairPdfBase64 = '';
let invPdfBase64 = '';
let repairItems = [];
let invItems = [];

// Repair Items Functions
function addRepairItem() {
    const id = Date.now();
    repairItems.push({ id: id, name: '', desc: '', inStock: false });
    renderRepairItems();
}

function removeRepairItem(id) {
    repairItems = repairItems.filter(item => item.id !== id);
    renderRepairItems();
}

function updateRepairItem(id, field, value) {
    const item = repairItems.find(i => i.id === id);
    if (item) item[field] = value;
}

function toggleRepairItemStock(id) {
    const item = repairItems.find(i => i.id === id);
    if (item) item.inStock = !item.inStock;
    renderRepairItems();
}

function renderRepairItems() {
    const container = document.getElementById('repairItemsList');
    if (repairItems.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm text-center py-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù - Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù"</p>';
        return;
    }
    container.innerHTML = repairItems.map(item => 
        '<div class="bg-white p-2 rounded border">' +
        '<div class="flex gap-2 items-center mb-2">' +
        '<input type="text" value="' + (item.name || '') + '" onchange="updateRepairItem(' + item.id + ', \'name\', this.value)" class="flex-1 p-1 border rounded text-sm" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">' +
        '<input type="text" value="' + (item.desc || '') + '" onchange="updateRepairItem(' + item.id + ', \'desc\', this.value)" class="flex-1 p-1 border rounded text-sm" placeholder="Ø§Ù„ÙˆØµÙ">' +
        '<button onclick="removeRepairItem(' + item.id + ')" class="text-red-500 p-1">âœ•</button>' +
        '</div>' +
        '<label class="flex items-center gap-2 text-sm cursor-pointer">' +
        '<input type="checkbox" ' + (item.inStock ? 'checked' : '') + ' onchange="toggleRepairItemStock(' + item.id + ')" class="w-4 h-4">' +
        '<span class="' + (item.inStock ? 'text-green-600 font-medium' : 'text-gray-600') + '">' + (item.inStock ? 'âœ“ Ù…ØªÙˆÙØ± Ø¨Ø§Ù„Ù…Ø®Ø²Ù†' : 'Ù…ØªÙˆÙØ± Ø¨Ø§Ù„Ù…Ø®Ø²Ù†ØŸ') + '</span>' +
        '</label>' +
        '</div>'
    ).join('');
}

// Invoice Items Functions
function addInvItem() {
    const id = Date.now();
    invItems.push({ id: id, name: '', price: '', qty: '' });
    renderInvItems();
}

function removeInvItem(id) {
    invItems = invItems.filter(item => item.id !== id);
    renderInvItems();
}

function updateInvItem(id, field, value) {
    const item = invItems.find(i => i.id === id);
    if (item) item[field] = value;
    if (field === 'price' || field === 'qty') {
    }
}


function renderInvItems() {
    const container = document.getElementById('invItemsList');
    if (invItems.length === 0) {
        container.innerHTML = '<p class="text-gray-400 text-sm text-center py-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù - Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù"</p>';
        return;
    }
    container.innerHTML = invItems.map(item => {
        const price = parseFloat(item.price) || 0;
        const qty = parseFloat(item.qty) || 0;
        const itemTotal = price * qty;
        return '<div class="bg-white p-2 rounded border">' +
        '<div class="flex gap-2 items-center mb-1">' +
        '<input type="text" value="' + (item.name || '') + '" onchange="updateInvItem(' + item.id + ', \'name\', this.value)" class="flex-1 p-1 border rounded text-sm" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">' +
        '<button onclick="removeInvItem(' + item.id + ')" class="text-red-500 p-1">âœ•</button>' +
        '</div>' +
        '<div class="flex gap-2 items-center">' +
        '<div class="flex-1"><label class="text-xs text-gray-500">Ø§Ù„Ø³Ø¹Ø±</label><input type="number" value="' + (item.price || '') + '" onchange="updateInvItem(' + item.id + ', \'price\', this.value)" oninput="updateInvItem(' + item.id + ', \'price\', this.value)" class="w-full p-1 border rounded text-sm" placeholder="0.00"></div>' +
        '<div class="w-20"><label class="text-xs text-gray-500">Ø§Ù„ÙƒÙ…ÙŠØ©</label><input type="number" value="' + (item.qty || '') + '" onchange="updateInvItem(' + item.id + ', \'qty\', this.value)" oninput="updateInvItem(' + item.id + ', \'qty\', this.value)" class="w-full p-1 border rounded text-sm" placeholder="1"></div>' +
        '<div class="w-24 text-left"><label class="text-xs text-gray-500">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</label><div class="p-1 bg-gray-100 rounded text-sm font-medium">' + itemTotal.toFixed(2) + '</div></div>' +
        '</div>' +
        '</div>';
    }).join('');
}

// Preview image function
function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            licenseImageBase64 = e.target.result;
            document.getElementById('previewImg').src = licenseImageBase64;
            document.getElementById('imagePreview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
}

// Preview repair PDF
function previewRepairPdf(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            repairPdfBase64 = e.target.result;
            document.getElementById('repairPdfName').textContent = file.name;
            document.getElementById('repairPdfPreview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
}

function removeRepairPdf() {
    repairPdfBase64 = '';
    document.getElementById('repairPdf').value = '';
    document.getElementById('repairPdfPreview').classList.add('hidden');
}

// Preview invoice PDF
function previewInvPdf(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            invPdfBase64 = e.target.result;
            document.getElementById('invPdfName').textContent = file.name;
            document.getElementById('invPdfPreview').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
}

function removeInvPdf() {
    invPdfBase64 = '';
    document.getElementById('invPdf').value = '';
    document.getElementById('invPdfPreview').classList.add('hidden');
}

auth.onAuthStateChanged(user => {
    document.getElementById('loading').classList.add('hidden');
    if (user) {
        currentUser = user;
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        loadCars();
    } else {
        document.getElementById('authScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
    }
});

function switchAuth(mode) {
    authMode = mode;
    document.getElementById('loginTab').className = mode === 'login' ? 'flex-1 py-2 rounded-lg bg-blue-600 text-white transition' : 'flex-1 py-2 rounded-lg text-gray-600 transition';
    document.getElementById('registerTab').className = mode === 'register' ? 'flex-1 py-2 rounded-lg bg-blue-600 text-white transition' : 'flex-1 py-2 rounded-lg text-gray-600 transition';
    document.getElementById('registerFields').classList.toggle('hidden', mode === 'login');
    document.getElementById('authBtn').textContent = mode === 'login' ? 'Ø¯Ø®ÙˆÙ„' : 'ØªØ³Ø¬ÙŠÙ„';
}

function showAuthMsg(msg, isError) {
    const el = document.getElementById('authMsg');
    el.textContent = msg;
    el.className = 'p-3 rounded-lg mb-4 text-sm ' + (isError ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700');
    el.classList.remove('hidden');
}

async function submitAuth() {
    const email = document.getElementById('authEmail').value;
    const password = document.getElementById('authPassword').value;
    if (!email || !password) { showAuthMsg('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„', true); return; }
    try {
        if (authMode === 'login') {
            await auth.signInWithEmailAndPassword(email, password);
        } else {
            // Check admin secret key first
            const adminKey = document.getElementById('adminSecretKey').value;
            if (adminKey !== 'admin@123') {
                showAuthMsg('ÙƒÙ„Ù…Ø© Ø³Ø± Ù…Ø³Ø¦ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± ØµØ­ÙŠØ­Ø© - Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨', true);
                return;
            }
            
            const pw2 = document.getElementById('authPassword2').value;
            if (password !== pw2) { showAuthMsg('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©', true); return; }
            const cred = await auth.createUserWithEmailAndPassword(email, password);
            await db.collection('users').doc(cred.user.uid).set({
                email: email,
                role: document.getElementById('authRole').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    } catch (e) { showAuthMsg(e.message, true); }
}

function logout() { auth.signOut(); }

function showScreen(screen) {
    ['cars', 'maintenance', 'reports'].forEach(s => {
        document.getElementById(s + 'Screen').classList.toggle('hidden', s !== screen);
        document.getElementById('nav' + s.charAt(0).toUpperCase() + s.slice(1)).className = s === screen ? 'px-6 py-3 font-medium text-blue-600 border-b-2 border-blue-600' : 'px-6 py-3 font-medium text-gray-600 border-b-2 border-transparent';
    });
    if (screen === 'maintenance') updateCarSelect();
    if (screen === 'reports') updateReportCarSelect();
}

async function loadCars() {
    const snapshot = await db.collection('cars').where('userId', '==', currentUser.uid).get();
    allCars = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderCars();
}

function renderCars() {
    const container = document.getElementById('carsList');
    if (allCars.length === 0) {
        container.innerHTML = '<div class="bg-white rounded-lg p-8 text-center text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø©</div>';
        return;
    }
    container.innerHTML = allCars.map(c => '<div class="bg-white rounded-lg shadow p-4 flex justify-between items-center"><div class="flex items-center gap-4">' + (c.licImage ? '<img src="' + c.licImage + '" class="w-16 h-16 object-cover rounded">' : '<div class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center text-gray-400">Ù„Ø§ ØµÙˆØ±Ø©</div>') + '<div><h3 class="font-bold">' + c.plateL + ' - ' + c.plateN + '</h3><p class="text-gray-600 text-sm">' + c.brand + ' - ' + c.year + '</p><div class="flex gap-2 mt-1"><span class="text-xs px-2 py-1 rounded ' + (c.status === 'ØµØ§Ù„Ø­Ø©' ? 'bg-green-100 text-green-800' : c.status === 'Ù…Ø¹Ø·Ù„Ø©' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800') + '">' + c.status + '</span><span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-800">' + c.carType + '</span></div></div></div><div class="flex gap-2"><button onclick="viewCar(\'' + c.id + '\')" class="text-green-600 hover:bg-green-50 p-2 rounded">Ø¹Ø±Ø¶</button><button onclick="editCar(\'' + c.id + '\')" class="text-blue-600 hover:bg-blue-50 p-2 rounded">ØªØ¹Ø¯ÙŠÙ„</button><button onclick="deleteCar(\'' + c.id + '\')" class="text-red-600 hover:bg-red-50 p-2 rounded">Ø­Ø°Ù</button></div></div>').join('');
}

function openCarForm() {
    editingCarId = null;
    licenseImageBase64 = '';
    document.getElementById('carFormTitle').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø³ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©';
    // Clear all fields
    ['plateL','plateN','brand','year','engine','chassis','cyl','licStart','licAuth','carUsers','custodian','licRenewal','ownership','maintDate','odometer','maintOdometer','maintTasks','supplier','nextMaint'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('carType').value = '';
    document.getElementById('status').value = '';
    document.getElementById('fuel').value = '';
    document.getElementById('licImage').value = '';
    document.getElementById('imagePreview').classList.add('hidden');
    document.getElementById('carModal').classList.remove('hidden');
}

function viewCar(id) {
    const car = allCars.find(c => c.id === id);
    if (!car) return;
    let details = 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©:\n\n';
    details += 'Ø§Ù„Ù„ÙˆØ­Ø©: ' + car.plateL + ' - ' + car.plateN + '\n';
    details += 'Ø§Ù„Ù…Ø§Ø±ÙƒØ©: ' + car.brand + '\n';
    details += 'Ø³Ù†Ø© Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: ' + car.year + '\n';
    details += 'Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØªÙˆØ±: ' + car.engine + '\n';
    details += 'Ø±Ù‚Ù… Ø§Ù„Ø´Ø§Ø³ÙŠØ©: ' + car.chassis + '\n';
    details += 'Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ù„Ù†Ø¯Ø±Ø§Øª: ' + car.cyl + '\n';
    details += 'Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ' + car.carType + '\n';
    details += 'Ø§Ù„Ø­Ø§Ù„Ø©: ' + car.status + '\n';
    details += 'Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ‚ÙˆØ¯: ' + car.fuel + '\n';
    details += 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±Ø®ÙŠØµ: ' + (car.licStart || '-') + '\n';
    details += 'Ø¬Ù‡Ø© Ø§Ù„ØªØ±Ø®ÙŠØµ: ' + car.licAuth + '\n';
    if (car.carUsers) details += 'Ù…Ø³ØªØ®Ø¯Ù…Ùˆ Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ' + car.carUsers + '\n';
    if (car.custodian) details += 'Ø¨Ø¹Ù‡Ø¯Ø©: ' + car.custodian + '\n';
    if (car.licRenewal) details += 'ØªØ§Ø±ÙŠØ® ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ØªØ±Ø®ÙŠØµ: ' + car.licRenewal + '\n';
    if (car.ownership) details += 'ØªØ³Ù„Ø³Ù„ Ø§Ù„Ù…Ù„ÙƒÙŠØ©: ' + car.ownership + '\n';
    if (car.maintDate) details += 'ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙŠØ§Ù†Ø©: ' + car.maintDate + '\n';
    if (car.odometer) details += 'Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯: ' + car.odometer + '\n';
    if (car.maintOdometer) details += 'Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø¹Ù†Ø¯ Ø§Ù„ØµÙŠØ§Ù†Ø©: ' + car.maintOdometer + '\n';
    if (car.maintTasks) details += 'Ø§Ù„Ù…Ù‡Ø§Ù…/Ù‚Ø·Ø¹ Ø§Ù„ØºÙŠØ§Ø±: ' + car.maintTasks + '\n';
    if (car.supplier) details += 'Ø§Ù„Ù…ÙˆØ±Ø¯: ' + car.supplier + '\n';
    if (car.nextMaint) details += 'Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©: ' + car.nextMaint + '\n';
    alert(details);
}

function editCar(id) {
    const car = allCars.find(c => c.id === id);
    if (!car) return;
    editingCarId = id;
    licenseImageBase64 = car.licImage || '';
    document.getElementById('carFormTitle').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©';
    document.getElementById('plateL').value = car.plateL || '';
    document.getElementById('plateN').value = car.plateN || '';
    document.getElementById('brand').value = car.brand || '';
    document.getElementById('year').value = car.year || '';
    document.getElementById('engine').value = car.engine || '';
    document.getElementById('chassis').value = car.chassis || '';
    document.getElementById('cyl').value = car.cyl || '';
    document.getElementById('carType').value = car.carType || '';
    document.getElementById('status').value = car.status || '';
    document.getElementById('licStart').value = car.licStart || '';
    document.getElementById('licAuth').value = car.licAuth || '';
    document.getElementById('fuel').value = car.fuel || '';
    document.getElementById('carUsers').value = car.carUsers || '';
    document.getElementById('custodian').value = car.custodian || '';
    document.getElementById('licRenewal').value = car.licRenewal || '';
    document.getElementById('ownership').value = car.ownership || '';
    document.getElementById('maintDate').value = car.maintDate || '';
    document.getElementById('odometer').value = car.odometer || '';
    document.getElementById('maintOdometer').value = car.maintOdometer || '';
    document.getElementById('maintTasks').value = car.maintTasks || '';
    document.getElementById('supplier').value = car.supplier || '';
    document.getElementById('nextMaint').value = car.nextMaint || '';
    if (car.licImage) {
        document.getElementById('previewImg').src = car.licImage;
        document.getElementById('imagePreview').classList.remove('hidden');
    } else {
        document.getElementById('imagePreview').classList.add('hidden');
    }
    document.getElementById('carModal').classList.remove('hidden');
}

function closeCarForm() { document.getElementById('carModal').classList.add('hidden'); }

async function saveCar() {
    const data = {
        plateL: document.getElementById('plateL').value,
        plateN: document.getElementById('plateN').value,
        brand: document.getElementById('brand').value,
        year: document.getElementById('year').value,
        engine: document.getElementById('engine').value,
        chassis: document.getElementById('chassis').value,
        cyl: document.getElementById('cyl').value,
        carType: document.getElementById('carType').value,
        status: document.getElementById('status').value,
        licStart: document.getElementById('licStart').value,
        licAuth: document.getElementById('licAuth').value,
        fuel: document.getElementById('fuel').value,
        carUsers: document.getElementById('carUsers').value,
        custodian: document.getElementById('custodian').value,
        licRenewal: document.getElementById('licRenewal').value,
        ownership: document.getElementById('ownership').value,
        maintDate: document.getElementById('maintDate').value,
        odometer: document.getElementById('odometer').value,
        maintOdometer: document.getElementById('maintOdometer').value,
        maintTasks: document.getElementById('maintTasks').value,
        supplier: document.getElementById('supplier').value,
        nextMaint: document.getElementById('nextMaint').value,
        licImage: licenseImageBase64,
        userId: currentUser.uid
    };
    
    if (!data.plateL || !data.plateN || !data.brand || !data.year || !data.engine || !data.chassis || !data.cyl || !data.carType || !data.status || !data.licStart || !data.licAuth || !data.fuel) {
        alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©'); return;
    }
    
    try {
        if (editingCarId) { await db.collection('cars').doc(editingCarId).update(data); }
        else { await db.collection('cars').add(data); }
        closeCarForm(); loadCars();
        alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
    } catch (e) { alert('Ø®Ø·Ø£: ' + e.message); }
}

async function deleteCar(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø©ØŸ')) return;
    await db.collection('cars').doc(id).delete();
    loadCars();
}

function updateCarSelect() {
    document.getElementById('carSelect').innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø³ÙŠØ§Ø±Ø© --</option>' + allCars.map(c => '<option value="' + c.id + '">' + c.plateL + ' - ' + c.plateN + ' (' + c.brand + ')</option>').join('');
}

async function loadCarData() {
    selectedCarId = document.getElementById('carSelect').value;
    if (!selectedCarId) { document.getElementById('carDetails').classList.add('hidden'); return; }
    const car = allCars.find(c => c.id === selectedCarId);
    document.getElementById('selectedCarInfo').innerHTML = '<strong>Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</strong> ' + car.plateL + ' - ' + car.plateN + ' | ' + car.brand + ' ' + car.year + ' | ' + car.status;
    document.getElementById('carDetails').classList.remove('hidden');
    loadRepairs(); loadInvoices();
}

function showTab(tab) {
    document.getElementById('repairsTab').classList.toggle('hidden', tab !== 'repairs');
    document.getElementById('invoicesTab').classList.toggle('hidden', tab !== 'invoices');
    document.getElementById('tabRepairs').className = tab === 'repairs' ? 'flex-1 py-2 rounded-lg bg-blue-600 text-white' : 'flex-1 py-2 rounded-lg bg-white';
    document.getElementById('tabInvoices').className = tab === 'invoices' ? 'flex-1 py-2 rounded-lg bg-blue-600 text-white' : 'flex-1 py-2 rounded-lg bg-white';
}

async function loadRepairs() {
    const snapshot = await db.collection('repairs').where('carId', '==', selectedCarId).get();
    const repairs = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    document.getElementById('repairsList').innerHTML = repairs.length === 0 ? '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</p>' : repairs.map(r => {
        const itemsCount = r.items ? r.items.length : 0;
        const itemsText = itemsCount > 0 ? ' (' + itemsCount + ' ØµÙ†Ù)' : '';
        return '<div class="border-b py-3 flex justify-between items-center"><div><strong>' + (r.date || '') + '</strong> - ' + (r.driver || '') + itemsText + (r.odometer ? ' - Ø§Ù„Ø¹Ø¯Ø§Ø¯: ' + r.odometer : '') + (r.pdfFile ? ' <span class="text-red-600">ğŸ“„</span>' : '') + '</div><div class="flex gap-2">' + (r.pdfFile ? '<button onclick="openPdf(\'' + r.id + '\', \'repair\')" class="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-sm">PDF</button>' : '') + '<button onclick="viewRepair(\'' + r.id + '\')" class="text-green-600 hover:bg-green-50 px-2 py-1 rounded text-sm">Ø¹Ø±Ø¶</button><button onclick="editRepair(\'' + r.id + '\')" class="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-sm">ØªØ¹Ø¯ÙŠÙ„</button><button onclick="deleteRepair(\'' + r.id + '\')" class="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-sm">Ø­Ø°Ù</button></div></div>';
    }).join('');
    window.repairsData = repairs;
}

async function loadInvoices() {
    const snapshot = await db.collection('invoices').where('carId', '==', selectedCarId).get();
    const invoices = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    document.getElementById('invoicesList').innerHTML = invoices.length === 0 ? '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±</p>' : invoices.map(i => {
        const itemsCount = i.items ? i.items.length : 0;
        const itemsText = itemsCount > 0 ? ' (' + itemsCount + ' ØµÙ†Ù)' : '';
        return '<div class="border-b py-3 flex justify-between items-center"><div><strong>#' + i.num + '</strong> - ' + i.vendor + ' - ' + i.total + ' Ø¬.Ù…' + itemsText + (i.pdfFile ? ' <span class="text-red-600">ğŸ“„</span>' : '') + '</div><div class="flex gap-2">' + (i.pdfFile ? '<button onclick="openPdf(\'' + i.id + '\', \'invoice\')" class="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-sm">PDF</button>' : '') + '<button onclick="viewInvoice(\'' + i.id + '\')" class="text-green-600 hover:bg-green-50 px-2 py-1 rounded text-sm">Ø¹Ø±Ø¶</button><button onclick="editInvoice(\'' + i.id + '\')" class="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-sm">ØªØ¹Ø¯ÙŠÙ„</button><button onclick="deleteInvoice(\'' + i.id + '\')" class="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-sm">Ø­Ø°Ù</button></div></div>';
    }).join('');
    window.invoicesData = invoices;
}

function openRepairForm(editId = null) {
    window.editingRepairId = editId;
    repairPdfBase64 = '';
    repairItems = [];
    document.getElementById('repairPdf').value = '';
    document.getElementById('repairPdfPreview').classList.add('hidden');
    
    if (editId && window.repairsData) {
        const r = window.repairsData.find(x => x.id === editId);
        if (r) {
            document.getElementById('repairDate').value = r.date || '';
            document.getElementById('repairDriver').value = r.driver || '';
            document.getElementById('repairOdometer').value = r.odometer || '';
            if (r.items && r.items.length > 0) {
                repairItems = r.items.map((item, idx) => ({ id: Date.now() + idx, name: item.name || '', desc: item.desc || '', inStock: item.inStock || false }));
            }
            if (r.pdfFile) {
                repairPdfBase64 = r.pdfFile;
                document.getElementById('repairPdfName').textContent = 'Ù…Ù„Ù PDF Ù…Ø­ÙÙˆØ¸';
                document.getElementById('repairPdfPreview').classList.remove('hidden');
            }
        }
    } else {
        ['repairDate','repairDriver','repairOdometer'].forEach(id => document.getElementById(id).value = '');
    }
    renderRepairItems();
    document.getElementById('repairModal').classList.remove('hidden');
}
function closeRepairForm() { document.getElementById('repairModal').classList.add('hidden'); }

function viewRepair(id) {
    const r = window.repairsData.find(x => x.id === id);
    if (!r) return;
    let details = '=== ØªÙØ§ØµÙŠÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ ===\n\n';
    details += 'Ø§Ù„ØªØ§Ø±ÙŠØ®: ' + (r.date || '-') + '\n';
    details += 'Ø§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚: ' + (r.driver || '-') + '\n';
    details += 'Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯: ' + (r.odometer || '-') + '\n\n';
    if (r.items && r.items.length > 0) {
        details += '=== Ø§Ù„Ø£ØµÙ†Ø§Ù ===\n';
        r.items.forEach((item, idx) => {
            details += (idx + 1) + '. ' + (item.name || '-');
            if (item.desc) details += ' - ' + item.desc;
            details += item.inStock ? ' âœ“ (Ù…ØªÙˆÙØ± Ø¨Ø§Ù„Ù…Ø®Ø²Ù†)' : ' âœ— (ØºÙŠØ± Ù…ØªÙˆÙØ±)';
            details += '\n';
        });
    }
    alert(details);
}

function editRepair(id) {
    openRepairForm(id);
}

async function deleteRepair(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø·Ù„Ø¨ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ØŸ')) return;
    await db.collection('repairs').doc(id).delete();
    loadRepairs();
}

async function saveRepair() {
    const date = document.getElementById('repairDate').value;
    const driver = document.getElementById('repairDriver').value;
    if (!date || !driver) { alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ø³Ù… Ø§Ù„Ø³Ø§Ø¦Ù‚'); return; }
    
    const data = {
        carId: selectedCarId,
        date: date,
        driver: driver,
        odometer: document.getElementById('repairOdometer').value,
        items: repairItems.map(item => ({ name: item.name, desc: item.desc, inStock: item.inStock })),
        pdfFile: repairPdfBase64,
        userId: currentUser.uid
    };
    
    if (window.editingRepairId) {
        await db.collection('repairs').doc(window.editingRepairId).update(data);
    } else {
        await db.collection('repairs').add(data);
    }
    closeRepairForm();
    loadRepairs();
    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
}

function openInvoiceForm(editId = null) {
    window.editingInvoiceId = editId;
    invPdfBase64 = '';
    invItems = [];
    document.getElementById('invPdf').value = '';
    document.getElementById('invPdfPreview').classList.add('hidden');
    
    if (editId && window.invoicesData) {
        const i = window.invoicesData.find(x => x.id === editId);
        if (i) {
            document.getElementById('invNum').value = i.num || '';
            document.getElementById('invVendor').value = i.vendor || '';
            if (i.items && i.items.length > 0) {
                invItems = i.items.map((item, idx) => ({ id: Date.now() + idx, name: item.name || '', price: item.price || '', qty: item.qty || '' }));
            }
            if (i.pdfFile) {
                invPdfBase64 = i.pdfFile;
                document.getElementById('invPdfName').textContent = 'Ù…Ù„Ù PDF Ù…Ø­ÙÙˆØ¸';
                document.getElementById('invPdfPreview').classList.remove('hidden');
            }
        }
    } else {
        ['invNum','invVendor'].forEach(id => document.getElementById(id).value = '');
    }
    renderInvItems();
    document.getElementById('invoiceModal').classList.remove('hidden');
}
function closeInvoiceForm() { document.getElementById('invoiceModal').classList.add('hidden'); }

function viewInvoice(id) {
    const i = window.invoicesData.find(x => x.id === id);
    if (!i) return;
    let details = '=== ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ===\n\n';
    details += 'Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ' + (i.num || '-') + '\n';
    details += 'Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø©: ' + (i.vendor || '-') + '\n';
    details += 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + (i.total || '-') + ' Ø¬.Ù…\n\n';
    if (i.items && i.items.length > 0) {
        details += '=== Ø§Ù„Ø£ØµÙ†Ø§Ù ===\n';
        i.items.forEach((item, idx) => {
            const price = parseFloat(item.price) || 0;
            const qty = parseFloat(item.qty) || 1;
            const itemTotal = price * qty;
            details += (idx + 1) + '. ' + (item.name || '-');
            details += ' | Ø§Ù„Ø³Ø¹Ø±: ' + price.toFixed(2);
            details += ' | Ø§Ù„ÙƒÙ…ÙŠØ©: ' + qty;
            details += ' | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + itemTotal.toFixed(2) + ' Ø¬.Ù…';
            details += '\n';
        });
    }
    alert(details);
}

function editInvoice(id) {
    openInvoiceForm(id);
}

async function deleteInvoice(id) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙØ§ØªÙˆØ±Ø©ØŸ')) return;
    await db.collection('invoices').doc(id).delete();
    loadInvoices();
}

async function saveInvoice() {
    const num = document.getElementById('invNum').value;
    const vendor = document.getElementById('invVendor').value;
    if (!num || !vendor) { alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©'); return; }
    
    // Check duplicate invoice number across ALL invoices (not just this car)
    const existing = await db.collection('invoices').where('num', '==', num).where('userId', '==', currentUser.uid).get();
    if (!existing.empty) {
        // If editing, check if it's the same invoice
        if (window.editingInvoiceId) {
            const isSameInvoice = existing.docs.some(doc => doc.id === window.editingInvoiceId);
            if (!isSameInvoice) {
                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© - Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© "' + num + '" Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
                return;
            }
        } else {
            alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø© - Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø© "' + num + '" Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
            return;
        }
    }
    
    const data = {
        carId: selectedCarId,
        num: num,
        vendor: vendor,
        items: invItems.map(item => ({ name: item.name, price: item.price, qty: item.qty })),
        pdfFile: invPdfBase64,
        userId: currentUser.uid
    };
    
    if (window.editingInvoiceId) {
        await db.collection('invoices').doc(window.editingInvoiceId).update(data);
    } else {
        await db.collection('invoices').add(data);
    }
    closeInvoiceForm();
    loadInvoices();
    alert('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­');
}

// Open PDF function
function openPdf(id, type) {
    let pdfData = '';
    if (type === 'repair' && window.repairsData) {
        const r = window.repairsData.find(x => x.id === id);
        if (r && r.pdfFile) pdfData = r.pdfFile;
    } else if (type === 'invoice' && window.invoicesData) {
        const i = window.invoicesData.find(x => x.id === id);
        if (i && i.pdfFile) pdfData = i.pdfFile;
    }
    
    if (pdfData) {
        const win = window.open();
        win.document.write('<iframe width="100%" height="100%" src="' + pdfData + '"></iframe>');
    } else {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù„Ù PDF');
    }
}

let searchResults = [];
let currentSearchType = 'car';
let carReportData = null;
let invoiceReportData = [];
let itemReportData = [];

function setSearchType(type) {
    currentSearchType = type;
    document.getElementById('searchTypeCar').className = type === 'car' ? 'px-4 py-2 rounded-lg bg-blue-600 text-white' : 'px-4 py-2 rounded-lg bg-gray-200';
    document.getElementById('searchTypeInvoice').className = type === 'invoice' ? 'px-4 py-2 rounded-lg bg-blue-600 text-white' : 'px-4 py-2 rounded-lg bg-gray-200';
    document.getElementById('searchTypeItem').className = type === 'item' ? 'px-4 py-2 rounded-lg bg-blue-600 text-white' : 'px-4 py-2 rounded-lg bg-gray-200';
    
    document.getElementById('searchByCar').classList.toggle('hidden', type !== 'car');
    document.getElementById('searchByInvoice').classList.toggle('hidden', type !== 'invoice');
    document.getElementById('searchByItem').classList.toggle('hidden', type !== 'item');
    
    // Hide all results
    document.getElementById('searchResults').classList.add('hidden');
    document.getElementById('carReportSection').classList.add('hidden');
    document.getElementById('invoiceSearchResults').classList.add('hidden');
    document.getElementById('itemSearchResults').classList.add('hidden');
}

function updateReportCarSelect() {
    document.getElementById('reportCarSelect').innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø³ÙŠØ§Ø±Ø© --</option>' + allCars.map(c => '<option value="' + c.id + '">' + c.plateL + ' - ' + c.plateN + ' (' + c.brand + ')</option>').join('');
}

async function loadCarReport() {
    const carId = document.getElementById('reportCarSelect').value;
    if (!carId) {
        document.getElementById('carReportSection').classList.add('hidden');
        return;
    }
    
    const car = allCars.find(c => c.id === carId);
    if (!car) return;
    
    // Load repairs and invoices for this car
    const repairsSnapshot = await db.collection('repairs').where('carId', '==', carId).get();
    const repairs = repairsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    
    const invoicesSnapshot = await db.collection('invoices').where('carId', '==', carId).get();
    const invoices = invoicesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    
    carReportData = { car, repairs, invoices };
    
    let html = '<div class="border-b pb-4 mb-4">';
    html += '<h4 class="font-bold text-blue-800 mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©</h4>';
    html += '<div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-sm">';
    html += '<div><span class="text-gray-500">Ø§Ù„Ù„ÙˆØ­Ø©:</span> ' + car.plateL + ' - ' + car.plateN + '</div>';
    html += '<div><span class="text-gray-500">Ø§Ù„Ù…Ø§Ø±ÙƒØ©:</span> ' + car.brand + '</div>';
    html += '<div><span class="text-gray-500">Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„:</span> ' + car.year + '</div>';
    html += '<div><span class="text-gray-500">Ø§Ù„Ø­Ø§Ù„Ø©:</span> ' + car.status + '</div>';
    html += '<div><span class="text-gray-500">Ø§Ù„Ù†ÙˆØ¹:</span> ' + car.carType + '</div>';
    html += '<div><span class="text-gray-500">Ø§Ù„ÙˆÙ‚ÙˆØ¯:</span> ' + car.fuel + '</div>';
    if (car.custodian) html += '<div><span class="text-gray-500">Ø§Ù„Ù…Ø³ØªØ¹Ù‡Ø¯:</span> ' + car.custodian + '</div>';
    html += '</div></div>';
    
    // Repairs section
    html += '<div class="border-b pb-4 mb-4">';
    html += '<h4 class="font-bold text-green-800 mb-2">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (' + repairs.length + ')</h4>';
    if (repairs.length === 0) {
        html += '<p class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¥ØµÙ„Ø§Ø­</p>';
    } else {
        html += '<div class="space-y-2">';
        repairs.forEach((r, idx) => {
            html += '<div class="bg-gray-50 p-2 rounded text-sm">';
            html += '<div class="font-medium">' + (idx + 1) + '. ' + (r.date || '-') + ' - ' + (r.driver || '-') + '</div>';
            if (r.items && r.items.length > 0) {
                html += '<div class="mr-4 text-gray-600">Ø§Ù„Ø£ØµÙ†Ø§Ù: ';
                html += r.items.map(item => item.name + (item.inStock ? ' âœ“' : ' âœ—')).join('ØŒ ');
                html += '</div>';
            }
            html += '</div>';
        });
        html += '</div>';
    }
    html += '</div>';
    
    // Invoices section
    html += '<div>';
    html += '<h4 class="font-bold text-purple-800 mb-2">Ø§Ù„ÙÙˆØ§ØªÙŠØ± (' + invoices.length + ')</h4>';
    if (invoices.length === 0) {
        html += '<p class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ±</p>';
    } else {
        let totalAmount = 0;
        html += '<div class="space-y-2">';
        invoices.forEach((inv, idx) => {
            totalAmount += parseFloat(inv.total) || 0;
            html += '<div class="bg-gray-50 p-2 rounded text-sm">';
            html += '<div class="font-medium">' + (idx + 1) + '. ÙØ§ØªÙˆØ±Ø© #' + inv.num + ' - ' + inv.vendor + ' - ' + inv.total + ' Ø¬.Ù…</div>';
            if (inv.items && inv.items.length > 0) {
                html += '<div class="mr-4 text-gray-600">Ø§Ù„Ø£ØµÙ†Ø§Ù: ';
                html += inv.items.map(item => item.name + ' (' + (item.qty || 1) + ' Ã— ' + (item.price || 0) + ')').join('ØŒ ');
                html += '</div>';
            }
            html += '</div>';
        });
        html += '</div>';
        html += '<div class="mt-3 p-2 bg-purple-100 rounded font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ' + totalAmount.toFixed(2) + ' Ø¬.Ù…</div>';
    }
    html += '</div>';
    
    document.getElementById('carReportContent').innerHTML = html;
    document.getElementById('carReportSection').classList.remove('hidden');
    document.getElementById('searchResults').classList.add('hidden');
}

async function searchByInvoiceNum() {
    const query = document.getElementById('invoiceSearchQuery').value.trim();
    if (!query) { alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©'); return; }
    
    const snapshot = await db.collection('invoices').where('userId', '==', currentUser.uid).get();
    const allInvoices = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    
    invoiceReportData = allInvoices.filter(inv => inv.num && inv.num.includes(query));
    
    if (invoiceReportData.length === 0) {
        document.getElementById('invoiceResultsContent').innerHTML = '<p class="text-gray-500 text-center py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
    } else {
        let html = '<div class="space-y-3">';
        for (const inv of invoiceReportData) {
            const car = allCars.find(c => c.id === inv.carId);
            html += '<div class="bg-gray-50 p-3 rounded border">';
            html += '<div class="font-bold text-purple-800">ÙØ§ØªÙˆØ±Ø© #' + inv.num + '</div>';
            html += '<div class="text-sm text-gray-600">Ø§Ù„Ø¬Ù‡Ø©: ' + inv.vendor + ' | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + inv.total + ' Ø¬.Ù…</div>';
            if (car) html += '<div class="text-sm text-blue-600">Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ' + car.plateL + ' - ' + car.plateN + ' (' + car.brand + ')</div>';
            if (inv.items && inv.items.length > 0) {
                html += '<div class="text-sm mt-1">Ø§Ù„Ø£ØµÙ†Ø§Ù: ' + inv.items.map(i => i.name).join('ØŒ ') + '</div>';
            }
            html += '</div>';
        }
        html += '</div>';
        document.getElementById('invoiceResultsContent').innerHTML = html;
    }
    document.getElementById('invoiceSearchResults').classList.remove('hidden');
}

async function searchByItemName() {
    const query = document.getElementById('itemSearchQuery').value.trim().toLowerCase();
    if (!query) { alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù'); return; }
    
    itemReportData = { repairs: [], invoices: [] };
    
    // Search in repairs
    const repairsSnapshot = await db.collection('repairs').where('userId', '==', currentUser.uid).get();
    const allRepairs = repairsSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    
    allRepairs.forEach(r => {
        if (r.items && r.items.some(item => item.name && item.name.toLowerCase().includes(query))) {
            itemReportData.repairs.push(r);
        }
    });
    
    // Search in invoices
    const invoicesSnapshot = await db.collection('invoices').where('userId', '==', currentUser.uid).get();
    const allInvoices = invoicesSnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    
    allInvoices.forEach(inv => {
        if (inv.items && inv.items.some(item => item.name && item.name.toLowerCase().includes(query))) {
            itemReportData.invoices.push(inv);
        }
    });
    
    let html = '';
    
    // Repairs with this item
    html += '<div class="mb-4">';
    html += '<h4 class="font-bold text-green-800 mb-2">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (' + itemReportData.repairs.length + ')</h4>';
    if (itemReportData.repairs.length === 0) {
        html += '<p class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¥ØµÙ„Ø§Ø­ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù</p>';
    } else {
        html += '<div class="space-y-2">';
        itemReportData.repairs.forEach(r => {
            const car = allCars.find(c => c.id === r.carId);
            html += '<div class="bg-gray-50 p-2 rounded text-sm border">';
            html += '<div class="font-medium">' + (r.date || '-') + ' - ' + (r.driver || '-') + '</div>';
            if (car) html += '<div class="text-blue-600">Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ' + car.plateL + ' - ' + car.plateN + '</div>';
            html += '<div class="text-gray-600">Ø§Ù„Ø£ØµÙ†Ø§Ù: ' + r.items.map(i => '<span class="' + (i.name.toLowerCase().includes(query) ? 'bg-yellow-200 px-1 rounded' : '') + '">' + i.name + '</span>').join('ØŒ ') + '</div>';
            html += '</div>';
        });
        html += '</div>';
    }
    html += '</div>';
    
    // Invoices with this item
    html += '<div>';
    html += '<h4 class="font-bold text-purple-800 mb-2">Ø§Ù„ÙÙˆØ§ØªÙŠØ± (' + itemReportData.invoices.length + ')</h4>';
    if (itemReportData.invoices.length === 0) {
        html += '<p class="text-gray-500 text-sm">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù</p>';
    } else {
        html += '<div class="space-y-2">';
        itemReportData.invoices.forEach(inv => {
            const car = allCars.find(c => c.id === inv.carId);
            html += '<div class="bg-gray-50 p-2 rounded text-sm border">';
            html += '<div class="font-medium">ÙØ§ØªÙˆØ±Ø© #' + inv.num + ' - ' + inv.vendor + ' - ' + inv.total + ' Ø¬.Ù…</div>';
            if (car) html += '<div class="text-blue-600">Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ' + car.plateL + ' - ' + car.plateN + '</div>';
            html += '<div class="text-gray-600">Ø§Ù„Ø£ØµÙ†Ø§Ù: ' + inv.items.map(i => '<span class="' + (i.name.toLowerCase().includes(query) ? 'bg-yellow-200 px-1 rounded' : '') + '">' + i.name + '</span>').join('ØŒ ') + '</div>';
            html += '</div>';
        });
        html += '</div>';
    }
    html += '</div>';
    
    document.getElementById('itemResultsContent').innerHTML = html;
    document.getElementById('itemSearchResults').classList.remove('hidden');
}

// PDF Download Functions
function downloadCarReportPDF() {
    if (!carReportData) return;
    
    const { car, repairs, invoices } = carReportData;
    let content = 'ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„Ø³ÙŠØ§Ø±Ø©\n';
    content += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
    content += 'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø©:\n';
    content += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    content += 'Ø§Ù„Ù„ÙˆØ­Ø©: ' + car.plateL + ' - ' + car.plateN + '\n';
    content += 'Ø§Ù„Ù…Ø§Ø±ÙƒØ©: ' + car.brand + '\n';
    content += 'Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„: ' + car.year + '\n';
    content += 'Ø§Ù„Ù†ÙˆØ¹: ' + car.carType + '\n';
    content += 'Ø§Ù„Ø­Ø§Ù„Ø©: ' + car.status + '\n';
    content += 'Ø§Ù„ÙˆÙ‚ÙˆØ¯: ' + car.fuel + '\n';
    if (car.custodian) content += 'Ø§Ù„Ù…Ø³ØªØ¹Ù‡Ø¯: ' + car.custodian + '\n';
    
    content += '\n\nØ·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (' + repairs.length + '):\n';
    content += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    repairs.forEach((r, idx) => {
        content += (idx + 1) + '. ' + (r.date || '-') + ' - ' + (r.driver || '-') + '\n';
        if (r.items && r.items.length > 0) {
            content += '   Ø§Ù„Ø£ØµÙ†Ø§Ù: ' + r.items.map(i => i.name + (i.inStock ? ' âœ“' : ' âœ—')).join('ØŒ ') + '\n';
        }
    });
    
    content += '\n\nØ§Ù„ÙÙˆØ§ØªÙŠØ± (' + invoices.length + '):\n';
    content += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    let total = 0;
    invoices.forEach((inv, idx) => {
        total += parseFloat(inv.total) || 0;
        content += (idx + 1) + '. ÙØ§ØªÙˆØ±Ø© #' + inv.num + ' - ' + inv.vendor + ' - ' + inv.total + ' Ø¬.Ù…\n';
        if (inv.items && inv.items.length > 0) {
            content += '   Ø§Ù„Ø£ØµÙ†Ø§Ù: ' + inv.items.map(i => i.name).join('ØŒ ') + '\n';
        }
    });
    content += '\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±: ' + total.toFixed(2) + ' Ø¬.Ù…\n';
    
    downloadTextAsPDF(content, 'ØªÙ‚Ø±ÙŠØ±_Ø³ÙŠØ§Ø±Ø©_' + car.plateL + '_' + car.plateN + '.pdf');
}

function downloadInvoiceReportPDF() {
    if (invoiceReportData.length === 0) return;
    
    let content = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ÙÙˆØ§ØªÙŠØ±\n';
    content += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
    
    invoiceReportData.forEach((inv, idx) => {
        const car = allCars.find(c => c.id === inv.carId);
        content += (idx + 1) + '. ÙØ§ØªÙˆØ±Ø© #' + inv.num + '\n';
        content += '   Ø§Ù„Ø¬Ù‡Ø©: ' + inv.vendor + '\n';
        content += '   Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + inv.total + ' Ø¬.Ù…\n';
        if (car) content += '   Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ' + car.plateL + ' - ' + car.plateN + ' (' + car.brand + ')\n';
        if (inv.items && inv.items.length > 0) {
            content += '   Ø§Ù„Ø£ØµÙ†Ø§Ù: ' + inv.items.map(i => i.name).join('ØŒ ') + '\n';
        }
        content += '\n';
    });
    
    downloadTextAsPDF(content, 'ØªÙ‚Ø±ÙŠØ±_ÙÙˆØ§ØªÙŠØ±.pdf');
}

function downloadItemReportPDF() {
    if (itemReportData.repairs.length === 0 && itemReportData.invoices.length === 0) return;
    
    const query = document.getElementById('itemSearchQuery').value;
    let content = 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„ØµÙ†Ù: ' + query + '\n';
    content += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
    
    content += 'Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¥ØµÙ„Ø§Ø­ (' + itemReportData.repairs.length + '):\n';
    content += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    itemReportData.repairs.forEach((r, idx) => {
        const car = allCars.find(c => c.id === r.carId);
        content += (idx + 1) + '. ' + (r.date || '-') + ' - ' + (r.driver || '-') + '\n';
        if (car) content += '   Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ' + car.plateL + ' - ' + car.plateN + '\n';
        if (r.items) content += '   Ø§Ù„Ø£ØµÙ†Ø§Ù: ' + r.items.map(i => i.name).join('ØŒ ') + '\n';
        content += '\n';
    });
    
    content += '\nØ§Ù„ÙÙˆØ§ØªÙŠØ± (' + itemReportData.invoices.length + '):\n';
    content += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
    itemReportData.invoices.forEach((inv, idx) => {
        const car = allCars.find(c => c.id === inv.carId);
        content += (idx + 1) + '. ÙØ§ØªÙˆØ±Ø© #' + inv.num + ' - ' + inv.vendor + ' - ' + inv.total + ' Ø¬.Ù…\n';
        if (car) content += '   Ø§Ù„Ø³ÙŠØ§Ø±Ø©: ' + car.plateL + ' - ' + car.plateN + '\n';
        if (inv.items) content += '   Ø§Ù„Ø£ØµÙ†Ø§Ù: ' + inv.items.map(i => i.name).join('ØŒ ') + '\n';
        content += '\n';
    });
    
    downloadTextAsPDF(content, 'ØªÙ‚Ø±ÙŠØ±_ØµÙ†Ù_' + query + '.pdf');
}

function downloadTextAsPDF(content, filename) {
    // Create a printable HTML
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<html dir="rtl"><head><title>' + filename + '</title>');
    printWindow.document.write('<style>body { font-family: Arial, sans-serif; padding: 20px; white-space: pre-wrap; line-height: 1.8; } @media print { body { padding: 0; } }</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(content.replace(/\n/g, '<br>'));
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}

function searchCars() {
    const query = document.getElementById('searchQuery').value.toLowerCase().trim();
    searchResults = !query ? [...allCars] : allCars.filter(c => 
        (c.plateL && c.plateL.toLowerCase().includes(query)) ||
        (c.plateN && c.plateN.toLowerCase().includes(query)) ||
        (c.brand && c.brand.toLowerCase().includes(query)) ||
        (c.carType && c.carType.toLowerCase().includes(query)) ||
        (c.status && c.status.toLowerCase().includes(query)) ||
        (c.custodian && c.custodian.toLowerCase().includes(query))
    );
    document.getElementById('searchResults').classList.remove('hidden');
    document.getElementById('carReportSection').classList.add('hidden');
    document.getElementById('resultsBody').innerHTML = searchResults.map(c => '<tr class="border-b"><td class="p-2">' + c.plateL + ' - ' + c.plateN + '</td><td class="p-2">' + c.brand + '</td><td class="p-2">' + c.year + '</td><td class="p-2">' + c.carType + '</td><td class="p-2"><span class="px-2 py-1 rounded text-xs ' + (c.status === 'ØµØ§Ù„Ø­Ø©' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800') + '">' + c.status + '</span></td></tr>').join('');
}

function exportCSV() {
    if (searchResults.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
    const headers = ['Ø§Ù„Ù„ÙˆØ­Ø©', 'Ø§Ù„Ù…Ø§Ø±ÙƒØ©', 'Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„', 'Ø§Ù„Ù†ÙˆØ¹', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'Ø§Ù„ÙˆÙ‚ÙˆØ¯', 'Ø§Ù„Ù…Ø³ØªØ¹Ù‡Ø¯'];
    const rows = searchResults.map(c => [c.plateL + '-' + c.plateN, c.brand, c.year, c.carType, c.status, c.fuel, c.custodian || '']);
    const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cars_report.csv';
    a.click();
}
</script>
</body>
</html>